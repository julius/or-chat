<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <title>OR Chat</title>
        <style>
            body {
                font-family: sans-serif;
                max-width: 800px;
                margin: auto;
                padding: 2rem;
            }

            #chat {
                white-space: pre-wrap;
                border: 1px solid #ccc;
                padding: 1rem;
                height: 300px;
                overflow-y: auto;
                background-color: #fdfdfd;
                border-radius: 6px;
            }

            .message {
                margin-bottom: 1.2em;
                padding-bottom: 0.5em;
                border-bottom: 1px solid #eee;
                position: relative;
            }

            .message-content {
                margin-bottom: 0.2em;
            }

            .message-buttons {
                position: absolute;
                right: 0;
                top: -10px;
                display: flex;
                gap: 0.3em;
                opacity: 0;
                transition: opacity 0.2s ease;
                background: white;
                border-radius: 10px;
                box-shadow: 0 0 4px #333;
                padding: 0 0 8px 10px;
            }

            .message:hover .message-buttons {
                opacity: 1;
            }

            .message-buttons button {
                background: none;
                border: none;
                cursor: pointer;
                padding: 0.2em;
                font-size: 1rem;
                color: #888;
            }

            .message-buttons button:hover {
                color: #000;
            }

            textarea {
                width: 100%;
                height: 60px;
                margin-top: 1rem;
                padding: 0.5rem;
                font-family: inherit;
                font-size: 1em;
            }

            button {
                padding: 0.4rem 0.8rem;
                margin-top: 0.5rem;
                margin-right: 0.5rem;
                font-size: 0.9em;
                cursor: pointer;
            }

            /* Edit Modal */
            #editModal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                display: none;
            }

            #editModalOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
            }

            #editModalBox {
                position: absolute;
                top: 50%;
                left: 50%;
                width: 90%;
                max-width: 500px;
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                transform: translate(-50%, -50%);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }

            #editModalBox h3 {
                margin-top: 0;
            }

            #editTextarea {
                width: 100%;
                height: 150px;
                font-size: 1em;
                font-family: inherit;
                margin-bottom: 1rem;
            }

            .modal-actions {
                text-align: right;
            }

            .modal-actions button {
                margin-left: 0.5rem;
            }

            #avatarPanel {
                width: 200px; /* match image width */
                text-align: center;
                flex-shrink: 0; /* prevent squishing on narrow screens */
            }

            #avatarImage {
                width: 200px;
                height: auto;
                border-radius: 10px;
                object-fit: cover;
                border: 1px solid #ccc;
            }

            #avatarUrlInput {
                width: 100%;
                font-size: 0.75em;
                padding: 0.3em;
                box-sizing: border-box;
                margin-top: 0.5rem;
            }

            .action-text {
                font-style: italic;
                color: #777;
            }

            .spoken-text {
                color: #2979ff; /* blue-ish */
            }
        </style>
    </head>
    <body>
        <div style="display: flex; gap: 1.5rem; align-items: flex-start">
            <div id="avatarPanel">
                <img id="avatarImage" src="" alt="Avatar" />
                <input type="text" id="avatarUrlInput" placeholder="Bild-URL einf√ºgen" />
            </div>

            <div style="flex: 1">
                <div id="chat"></div>
            </div>
        </div>

        <textarea id="userInput" placeholder="Schreibe eine Nachricht..."></textarea><br />
        <button onclick="sendMessage()">Senden</button>
        <button onclick="abortGeneration()">Abbrechen</button>
        <button onclick="clearChat()">Verlauf l√∂schen</button>

        <div style="padding: 20px 0 0 0">
            Model: <input type="text" id="modelId" style="width: 100%" />
        </div>

        <div style="padding: 20px 0 0 0">
            API-Key: <input type="text" id="apiKey" style="width: 100%" />
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem">
            <div style="flex: 1">
                <label for="systemLong"><strong>System Long</strong> <span id="systemLongTokenCount"></span></label>
                <br />
                <textarea id="systemLong" style="height: 100px"></textarea>
            </div>
            <div style="flex: 1">
                <label for="systemShort"><strong>System Short</strong> <span id="systemShortTokenCount"></span></label>
                <br />
                <textarea id="systemShort" style="height: 100px"></textarea>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal">
            <div id="editModalOverlay" onclick="closeEditModal()"></div>
            <div id="editModalBox">
                <h3>Nachricht bearbeiten</h3>
                <textarea id="editTextarea"></textarea>
                <div class="modal-actions">
                    <button onclick="saveEditedMessage()">Speichern</button>
                    <button onclick="closeEditModal()">Abbrechen</button>
                </div>
            </div>
        </div>

        <script>
            const chatBox = document.getElementById('chat');
            const userInput = document.getElementById('userInput');

            let messages = [];
            let controller = null;
            let isGenerating = false;
            let editIndex = null;

            function renderMessages() {
                chatBox.innerHTML = '';

                messages.forEach((msg, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('message');

                    const content = document.createElement('div');
                    content.classList.add('message-content');
                    if (msg.role === 'user') content.innerHTML = `üë§: ${renderStyledText(msg.content)}`;
                    else if (msg.role === 'assistant') content.innerHTML = `${renderStyledText(msg.content)}`;
                    else content.innerHTML = `üõ†Ô∏è: ${renderStyledText(msg.content)}`;

                    const actions = document.createElement('div');
                    actions.classList.add('message-buttons');
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '‚úèÔ∏è';
                    editBtn.title = 'Bearbeiten';
                    editBtn.onclick = () => openEditModal(index);
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = 'üóëÔ∏è';
                    removeBtn.title = 'Entfernen';
                    removeBtn.onclick = () => removeMessage(index);
                    const removeAfterBtn = document.createElement('button');
                    removeAfterBtn.innerHTML = '‚è©';
                    removeAfterBtn.title = 'Nachfolgende l√∂schen';
                    removeAfterBtn.onclick = () => removeAfter(index);
                    actions.append(editBtn, removeBtn, removeAfterBtn);

                    wrapper.append(content, actions);
                    chatBox.appendChild(wrapper);
                });

                chatBox.scrollTop = chatBox.scrollHeight;
                localStorage.setItem('chatMessages', JSON.stringify(messages));
            }

            function renderStyledText(text) {
                if (!text) return '';

                const escape = str =>
                    str.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[c]);

                let result = '';
                let mode = 'normal';
                let buffer = '';

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];

                    if (char === '*' && mode === 'normal') {
                        // flush normal text
                        if (buffer) result += escape(buffer);
                        buffer = '';
                        mode = 'action';
                        continue;
                    }

                    if (char === '*' && mode === 'action') {
                        result += `<span class="action-text">` + escape(buffer) + `</span>`;
                        buffer = '';
                        mode = 'normal';
                        continue;
                    }

                    if (char === `"` && mode === 'normal') {
                        if (buffer) result += escape(buffer);
                        buffer = '';
                        mode = 'spoken';
                        continue;
                    }

                    if (char === `"` && mode === 'spoken') {
                        result += `<span class="spoken-text">"` + escape(buffer) + `"</span>`;
                        buffer = '';
                        mode = 'normal';
                        continue;
                    }

                    buffer += char;
                }

                // flush leftovers
                if (buffer) {
                    if (mode === 'action') {
                        result += `<span class="action-text">` + escape(buffer) + `</span>`;
                    } else if (mode === 'spoken') {
                        result += `<span class="spoken-text">"` + escape(buffer) + `</span>`;
                    } else {
                        result += escape(buffer);
                    }
                }

                return result;
            }

            async function sendMessage() {
                if (isGenerating) return;
                const userMessage = userInput.value.trim();
                if (userMessage) {
                    messages.push({ role: 'user', content: userMessage });
                }

                isGenerating = true;
                renderMessages();

                controller = new AbortController();
                const signal = controller.signal;

                const aiMessage = { role: 'assistant', content: '' };
                messages.push(aiMessage);

                renderMessages();

                try {
                    const systemLong = document.getElementById('systemLong').value.trim();
                    const systemShort = document.getElementById('systemShort').value.trim();

                    const payloadMessages = [];

                    // System Long
                    if (systemLong) {
                        payloadMessages.push({ role: 'system', content: systemLong });
                    }

                    // Gather non-system messages
                    const nonSystem = messages.filter(m => m.role !== 'system');

                    const latestMessages = [];
                    for (let i = nonSystem.length - 1; i >= 0; i--) {
                        const m = nonSystem[i];
                        latestMessages.unshift(m);
                    }

                    // Insert System Short before last user/assistant
                    if (systemShort && latestMessages.length >= 2) {
                        latestMessages.splice(latestMessages.length - 2, 0, {
                            role: 'system',
                            content: systemShort,
                        });
                    }

                    // Final payload
                    payloadMessages.push(...latestMessages);

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer ' + document.getElementById('apiKey').value,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: document.getElementById('modelId').value,
                            messages: payloadMessages,
                            stream: true,
                        }),
                        signal,
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n').filter(line => line.startsWith('data: '));

                        for (const line of lines) {
                            const jsonStr = line.replace(/^data: /, '').trim();
                            if (jsonStr === '[DONE]') break;

                            try {
                                const parsed = JSON.parse(jsonStr);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                aiMessage.content += content;
                                renderMessages();
                            } catch (e) {
                                console.error('Fehler beim Parsen:', e, line);
                            }
                        }
                    }
                } catch (err) {
                    if (err.name === 'AbortError') {
                        aiMessage.content += '\n[‚õî Generierung abgebrochen]';
                        renderMessages();
                    } else {
                        console.error('Fetch-Fehler:', err);
                    }
                } finally {
                    isGenerating = false;
                    controller = null;
                    userInput.value = '';
                    chatBox.scrollTop = chatBox.scrollHeight;
                    localStorage.setItem('chatMessages', JSON.stringify(messages));
                }
            }

            function abortGeneration() {
                if (controller) controller.abort();
            }

            function clearChat() {
                localStorage.removeItem('chatMessages');
                messages = [];
                renderMessages();
            }

            function removeMessage(index) {
                messages.splice(index, 1);
                renderMessages();
            }

            function removeAfter(index) {
                messages = messages.slice(0, index + 1);
                renderMessages();
            }

            function openEditModal(index) {
                editIndex = index;
                document.getElementById('editTextarea').value = messages[index].content;
                document.getElementById('editModal').style.display = 'block';
            }

            function closeEditModal() {
                editIndex = null;
                document.getElementById('editModal').style.display = 'none';
            }

            function saveEditedMessage() {
                const newText = document.getElementById('editTextarea').value.trim();
                if (editIndex !== null && newText !== '') {
                    messages[editIndex].content = newText;
                    renderMessages();
                    closeEditModal();
                }
            }

            window.addEventListener('DOMContentLoaded', () => {
                // --- MESSAGES ---
                const saved = localStorage.getItem('chatMessages');
                if (saved) {
                    try {
                        messages = JSON.parse(saved);
                    } catch (e) {
                        console.error('Fehler beim Laden des gespeicherten Chats:', e);
                    }
                }
                renderMessages();

                // --- MODEL / KEY ---
                document.getElementById('modelId').value = localStorage.getItem('modelId') || '';
                document.getElementById('modelId').addEventListener('input', () => {
                    localStorage.setItem('modelId', document.getElementById('modelId').value);
                });
                document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
                document.getElementById('apiKey').addEventListener('input', () => {
                    localStorage.setItem('apiKey', document.getElementById('apiKey').value);
                });

                // --- SYSTEM MSG ---
                document.getElementById('systemLong').value = localStorage.getItem('systemLong') || '';
                document.getElementById('systemShort').value = localStorage.getItem('systemShort') || '';
                document.getElementById('systemLong').addEventListener('input', () => {
                    localStorage.setItem('systemLong', document.getElementById('systemLong').value);
                });
                document.getElementById('systemShort').addEventListener('input', () => {
                    localStorage.setItem('systemShort', document.getElementById('systemShort').value);
                });

                // --- AVATAR ---
                const avatarImage = document.getElementById('avatarImage');
                const avatarUrlInput = document.getElementById('avatarUrlInput');

                // Bild-URL aktualisieren und speichern
                function updateAvatarUrl() {
                    const url = avatarUrlInput.value.trim();
                    avatarImage.src = url;
                    localStorage.setItem('avatarUrl', url);
                }

                avatarUrlInput.addEventListener('input', updateAvatarUrl);

                // Beim Laden gespeicherte URL wiederherstellen
                const savedAvatarUrl = localStorage.getItem('avatarUrl');
                if (savedAvatarUrl) {
                    avatarUrlInput.value = savedAvatarUrl;
                    avatarImage.src = savedAvatarUrl;
                }
            });

        </script>
    </body>
</html>
